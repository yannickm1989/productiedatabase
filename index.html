<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Productiedatabase</title>

<style>
body{
    font-family:Arial;
    background:#f5f5f5;
    padding:20px;
}
.app{
    max-width:450px;
    margin:auto;
    background:white;
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
.title-bar{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#28a745;
    color:white;
    padding:10px;
    border-radius:8px;
    margin-bottom:15px;
}
.title-bar img{
    position:absolute;
    left:10px;
    height:40px;
}
.tab-buttons{
    display:flex;
    gap:10px;
    margin-bottom:15px;
}
.tab-buttons button{
    flex:1;
    background:#e0e0e0;
    border:none;
    padding:8px;
    border-radius:8px;
    cursor:pointer;
}
.tab-buttons button.active{
    background:#28a745;
    color:white;
    font-weight:bold;
}
label{
    font-weight:bold;
    display:block;
    margin-top:8px;
}
input{
    width:100%;
    padding:7px;
    margin-top:3px;
    border:1px solid #ccc;
    border-radius:4px;
}
button.main{
    margin-top:15px;
    width:100%;
    padding:10px;
    font-size:16px;
    background:#28a745;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
}
.scan-btn{
    margin-top:10px;
    width:100%;
    padding:8px;
    font-size:14px;
    background:#007bff;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
}
.result-card{
    border:1px solid #ccc;
    border-radius:8px;
    padding:10px;
    margin-top:10px;
}
.omschrijving{
    text-align:center;
    font-weight:bold;
    font-size:16px;
    margin-bottom:8px;
}
hr{margin:6px 0;}
</style>
</head>

<body>
<div class="app">

<div class="title-bar">
    <img src="ym.png" alt="YM">
    <h2>Productiedatabase</h2>
</div>

<div class="tab-buttons">
    <button id="tabInvoer" class="active">Invoer</button>
    <button id="tabZoek">Opzoeken</button>
</div>

<div id="invoerTab"></div>
<div id="zoekTab" style="display:none"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyBtV-MNtSxf7mJ5RM5dS_5MeRdpcOMy6a4",
 authDomain:"productiedatabase.firebaseapp.com",
 projectId:"productiedatabase",
 storageBucket:"productiedatabase.firebasestorage.app",
 messagingSenderId:"269980901692",
 appId:"1:269980901692:web:642b70f033694811817e39"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const colRef=collection(db,"Productiedatabase");

let editId=null;

const fields=[
 {k:"artikelnummer",l:"Artikelnummer"},
 {k:"omschrijving",l:"Omschrijving"},
 {k:"blikinhoud",l:"Blikinhoud"},
 {k:"deksel",l:"Deksel"},
 {k:"blik",l:"Blik"},
 {k:"verpakker1",l:"Verpakker 1"},
 {k:"verpakker2",l:"Verpakker 2"},
 {k:"hoeveelPerPak",l:"Hoeveel per pak"},
 {k:"secundaireFolie",l:"Secundaire folie"},
 {k:"tertiaireFolie",l:"Tertiaire folie"},
 {k:"tertiaireTopfolie",l:"Tertiaire topfolie"},
 {k:"pallet",l:"Pallet"},
 {k:"tussenlegger",l:"Tussenlegger"},
 {k:"plaatsingTussenleggers",l:"Plaatsing tussenleggers"},
 {k:"stapelprogramma",l:"Stapelprogramma"},
 {k:"aantalLagen",l:"Aantal lagen"},
 {k:"hoeveelPerLaag",l:"Hoeveel per laag"}
];

// invoer
const invoer=document.getElementById("invoerTab");

invoer.innerHTML+=`
<input type="file" id="scanInput" accept="image/*" capture="environment" style="display:none">
<button class="scan-btn" onclick="startScan()">üì∑ Scan productieblad</button>
<button class="scan-btn" onclick="clearFields()">‚úçÔ∏è Handmatig invoeren</button>
`;

fields.forEach(f=>{
 invoer.innerHTML+=`<label>${f.l}</label><input id="${f.k}">`;
});

invoer.innerHTML+=`<button class="main" onclick="save()">Opslaan</button>`;

// scan
window.startScan=()=>{
 document.getElementById("scanInput").click();
};

document.getElementById("scanInput").addEventListener("change", async e=>{
 const file=e.target.files[0];
 if(!file) return;

 const img=new Image();
 img.src=URL.createObjectURL(file);

 img.onload=async()=>{
  const zones={
   artikelnummer:[0.05,0.08,0.4,0.08],
   omschrijving:[0.05,0.16,0.6,0.10],
   blikinhoud:[0.70,0.16,0.25,0.08],
   deksel:[0.05,0.30,0.4,0.08],
   blik:[0.55,0.30,0.4,0.08],
   verpakker1:[0.05,0.40,0.4,0.08],
   verpakker2:[0.55,0.40,0.4,0.08],
   hoeveelPerPak:[0.05,0.52,0.4,0.08],
   secundaireFolie:[0.55,0.52,0.4,0.08],
   tertiaireFolie:[0.05,0.62,0.4,0.08],
   tertiaireTopfolie:[0.55,0.62,0.4,0.08],
   pallet:[0.05,0.74,0.4,0.08],
   tussenlegger:[0.55,0.74,0.4,0.08],
   plaatsingTussenleggers:[0.05,0.84,0.4,0.08],
   stapelprogramma:[0.55,0.84,0.4,0.08],
   aantalLagen:[0.05,0.92,0.4,0.08],
   hoeveelPerLaag:[0.55,0.92,0.4,0.08]
  };

  for(const key in zones){
   const [x,y,w,h]=zones[key];

   const canvas=document.createElement("canvas");
   canvas.width=img.width*w;
   canvas.height=img.height*h;

   const ctx=canvas.getContext("2d");
   ctx.drawImage(
    img,
    img.width*x,
    img.height*y,
    img.width*w,
    img.height*h,
    0,0,
    canvas.width,
    canvas.height
   );

   const { data:{ text } } =
     await Tesseract.recognize(canvas,"eng");

   const val=text.replace(/[\n:]/g," ").trim();

   if(val && document.getElementById(key)){
    document.getElementById(key).value=val;
   }
  }
 };
});

// handmatig
window.clearFields=()=>{
 fields.forEach(f=>{
  document.getElementById(f.k).value="";
 });
};

// save
window.save=async()=>{
 let data={};
 fields.forEach(f=>{
  data[f.k]=document.getElementById(f.k).value.trim();
 });
 if(editId) await updateDoc(doc(db,"Productiedatabase",editId),data);
 else await addDoc(colRef,data);

 fields.forEach(f=>document.getElementById(f.k).value="");
 alert("Opgeslagen");
};

// zoeken
document.getElementById("zoekTab").innerHTML=`
<label>Zoek op artikelnummer of omschrijving</label>
<input id="zoek">
<button class="main" onclick="zoek()">Zoek</button>
<div id="result"></div>`;

window.zoek=async()=>{
 const q=document.getElementById("zoek").value.trim().toUpperCase();
 const res=document.getElementById("result");
 res.innerHTML="";
 if(!q) return;

 const snap=await getDocs(colRef);
 snap.forEach(d=>{
  const data=d.data();
  if((data.artikelnummer||"").toUpperCase().includes(q) || (data.omschrijving||"").toUpperCase().includes(q)){
   let html=`<div class="result-card">`;
   if(data.omschrijving) html+=`<div class="omschrijving">${data.omschrijving}</div><hr>`;
   fields.forEach(f=>{
    if(f.k!=="omschrijving" && data[f.k]) html+=`<b>${f.l}:</b> ${data[f.k]}<br>`;
   });
   html+=`</div>`;
   res.innerHTML+=html;
  }
 });
};

// tabs
const tabInvoer=document.getElementById("tabInvoer");
const tabZoek=document.getElementById("tabZoek");
const invoerTab=document.getElementById("invoerTab");
const zoekTab=document.getElementById("zoekTab");

tabInvoer.onclick=()=>{
 tabInvoer.classList.add("active");
 tabZoek.classList.remove("active");
 invoerTab.style.display="block";
 zoekTab.style.display="none";
};
tabZoek.onclick=()=>{
 tabZoek.classList.add("active");
 tabInvoer.classList.remove("active");
 invoerTab.style.display="none";
 zoekTab.style.display="block";
};
</script>
</body>
</html>